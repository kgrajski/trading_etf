# Feature Documentation

This document describes all features generated by the ETF trading workflow, specifically by `src/workflow/03-generate-features.py`.

## Overview

Features are organized into three tiers:
- **L0 (Base)**: Core weekly OHLCV aggregations from daily data
- **L1 (Derived)**: Single-week log-transformed metrics
- **L2 (Temporal)**: Multi-week rolling/smoothed metrics

All weekly features are stored in:
```
data/historical/{tier}/weekly/{SYMBOL}.csv
```

Where `{tier}` is typically `iex` (free) or `sip` (paid).

---

## L0: Base Features

These are direct aggregations of daily OHLCV bars into weekly summaries.

| Column | Type | Description |
|--------|------|-------------|
| `symbol` | string | ETF ticker symbol (e.g., "XLF") |
| `week_start` | date | Monday of the ISO week (YYYY-MM-DD) |
| `week_end` | date | Last trading day of that week |
| `open` | float | Opening price of the week (first daily open) |
| `high` | float | Highest price during the week (max of daily highs) |
| `low` | float | Lowest price during the week (min of daily lows) |
| `close` | float | Closing price of the week (last daily close) |
| `volume` | int | Total shares traded during the week (sum of daily volumes) |
| `trade_count` | int | Total number of trades during the week |
| `trading_days` | int | Number of trading days in that week (typically 5, less for holidays) |

---

## L1: Derived Single-Week Features

These features are computed from a single week's L0 data. Log transforms are used for better statistical properties (approximate normality, additive returns).

### `log_return`
**Weekly log return**

```
log_return = log(close / open)
```

- **Interpretation**: The continuously-compounded return for the week
- **Range**: Typically -0.2 to +0.2 (±20% weekly moves are rare)
- **Note**: Uses open-to-close (not close-to-close) to capture intra-week movement

### `log_range`
**Log price range**

```
log_range = log(high / low)
```

- **Interpretation**: Measure of weekly price volatility/dispersion
- **Range**: Typically 0.01 to 0.15
- **Note**: Higher values indicate larger intra-week price swings

### `log_volume`
**Log of total weekly volume**

```
log_volume = log(volume)
```

- **Interpretation**: Normalized trading activity measure
- **Range**: Typically 14 to 22 (for volumes of 1M to 4B shares)
- **Why log?**: Volume is highly skewed; log transform normalizes it

### `log_avg_daily_volume`
**Log of average daily volume**

```
log_avg_daily_volume = log(volume / trading_days)
```

- **Interpretation**: Normalized per-day trading activity
- **Range**: Similar to `log_volume` minus ~1.6 (since dividing by ~5 days)
- **Use**: Accounts for short weeks (holidays)

### `intra_week_volatility`
**Standard deviation of daily log returns within the week**

```
daily_log_return = log(close_t / close_{t-1})  # for each day
intra_week_volatility = std(daily_log_return)  # across all days in week
```

- **Interpretation**: Realized volatility at the daily level
- **Range**: Typically 0.005 to 0.05
- **Note**: Higher values indicate choppier price action during the week

---

## L2: Temporal Multi-Week Features

These features incorporate historical context using rolling windows.

### Lookback Periods

| Name | Weeks | Purpose |
|------|-------|---------|
| `short` | 1 | Week-over-week changes |
| `medium` | 4 | ~1 month trend (4 weeks) |
| `long` | 12 | ~3 month trend (12 weeks) |

### `log_volume_delta`
**Week-over-week change in log volume**

```
log_volume_delta = log_volume_t - log_volume_{t-1}
```

- **Interpretation**: Is volume increasing or decreasing vs. last week?
- **Range**: Typically -1.5 to +1.5
- **Use**: Positive = volume surge; Negative = volume decline

### `log_return_ma4`
**4-week moving average of log returns**

```
log_return_ma4 = mean(log_return) over past 4 weeks
```

- **Interpretation**: Smoothed short-term trend direction
- **Range**: Typically -0.05 to +0.05
- **Use**: Positive = recent uptrend; Negative = recent downtrend

### `log_volume_ma4`
**4-week moving average of log volume**

```
log_volume_ma4 = mean(log_volume) over past 4 weeks
```

- **Interpretation**: Smoothed short-term volume level
- **Use**: Compare current `log_volume` to this for relative activity

### `momentum_4w`
**4-week price momentum**

```
momentum_4w = log(close_t / close_{t-4})
```

- **Interpretation**: Total return over the past 4 weeks
- **Range**: Typically -0.3 to +0.3
- **Use**: Positive = price is higher than 4 weeks ago; key for momentum strategies

### `volatility_ma4`
**4-week moving average of intra-week volatility**

```
volatility_ma4 = mean(intra_week_volatility) over past 4 weeks
```

- **Interpretation**: Smoothed short-term volatility regime
- **Use**: High = volatile period; Low = calm period

### `log_return_ma12`
**12-week moving average of log returns**

```
log_return_ma12 = mean(log_return) over past 12 weeks
```

- **Interpretation**: Smoothed medium-term trend direction (~3 months)
- **Use**: More stable trend indicator than 4-week MA

### `log_volume_ma12`
**12-week moving average of log volume**

```
log_volume_ma12 = mean(log_volume) over past 12 weeks
```

- **Interpretation**: Baseline volume level over ~3 months
- **Use**: Compare current volume to identify unusual activity

### `momentum_12w`
**12-week price momentum**

```
momentum_12w = log(close_t / close_{t-12})
```

- **Interpretation**: Total return over the past 12 weeks (~3 months)
- **Range**: Typically -0.5 to +0.5
- **Use**: Medium-term momentum; often used for sector rotation

### `volatility_ma12`
**12-week moving average of intra-week volatility**

```
volatility_ma12 = mean(intra_week_volatility) over past 12 weeks
```

- **Interpretation**: Medium-term volatility baseline
- **Use**: Identify volatility regime changes

---

## Feature Matrix (Script 05)

The `05-build-feature-matrix.py` script combines weekly features from all symbols into cross-sectional matrices:

### Output Files

| File | Description |
|------|-------------|
| `data/features/{tier}/feature_matrix.parquet` | Features from all symbols (rows=weeks, cols=symbol_feature) |
| `data/features/{tier}/target_matrix.parquet` | Prediction targets (rows=weeks, cols=symbols) |
| `data/features/{tier}/metadata.json` | Dimensions, date range, symbols list |
| `data/features/{tier}/config.json` | Configuration used to build matrices |

### Default Features in Matrix

The following subset of features is included in the cross-sectional matrix (configurable in `config.py`):

```python
MATRIX_FEATURES = [
    "log_return",
    "log_range",
    "log_volume",
    "momentum_4w",
    "momentum_12w",
    "intra_week_volatility",
    "log_volume_delta",
]
```

### Column Naming Convention

Feature matrix columns follow the pattern: `{SYMBOL}_{feature}`

Example: `XLF_log_return`, `XLF_momentum_4w`, `VTI_log_volume`, etc.

---

## Configuration

All feature settings are controlled in `src/workflow/config.py`:

```python
# Enable/disable individual features
FEATURES_ENABLED = {
    "L1_log_return": True,
    "L1_log_range": True,
    ...
}

# Lookback periods (weeks)
LOOKBACK_PERIODS = {
    "short": 1,
    "medium": 4,
    "long": 12,
}
```

---

## Quick Reference

| Feature | Formula | Typical Range | Interpretation |
|---------|---------|---------------|----------------|
| `log_return` | log(close/open) | ±0.1 | Weekly return |
| `log_range` | log(high/low) | 0.01–0.15 | Price dispersion |
| `log_volume` | log(volume) | 14–22 | Trading activity |
| `intra_week_volatility` | std(daily returns) | 0.005–0.05 | Realized vol |
| `log_volume_delta` | Δlog_volume | ±1.5 | Volume change |
| `momentum_4w` | log(close_t/close_{t-4}) | ±0.3 | 1-month momentum |
| `momentum_12w` | log(close_t/close_{t-12}) | ±0.5 | 3-month momentum |

---

## File Locations

```
data/
├── historical/
│   └── iex/
│       ├── daily/          # Raw daily bars (from 02-fetch-daily-data.py)
│       │   ├── XLF.csv
│       │   └── ...
│       └── weekly/         # Derived features (from 03-generate-features.py)
│           ├── XLF.csv     # Contains all L0, L1, L2 features
│           ├── ...
│           └── _manifest.json
└── features/
    └── iex/
        ├── feature_matrix.parquet  # Cross-sectional features
        ├── target_matrix.parquet   # Prediction targets
        ├── config.json
        └── metadata.json
```
