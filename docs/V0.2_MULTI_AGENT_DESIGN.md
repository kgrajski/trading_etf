# v0.2 Design — Multi-Agent ETF Analyst

**Status:** Design (not implementation)
**Date:** 2026-02-17
**Predecessor:** `v0.1-analyst-freeze`

---

## Design Goals

1. **Multi-agent architecture** — Distinct specialist agents with defined roles, tools,
   and interaction patterns. Move beyond single-agent sequential workflow.
2. **Quantitative grounding** — Inject technical/statistical features into the analysis
   so the LLM can distinguish market-wide (beta) from idiosyncratic (alpha) moves.
3. **Sector-aware analysis** — Group ETFs by sector/theme before analysis. Search and
   analyze per-sector, not per-symbol.
4. **Epistemic honesty** — When evidence is weak, say so clearly. No hallucinated
   narratives.
5. **Unified pipeline** — Single script, single set of strategy parameters, single
   dashboard. Eliminate the 19.3 vs 21b split.
6. **Learning objective** — Exercise multi-agent patterns: delegation, parallel execution,
   structured handoffs, debate/critique, and hierarchical review.

---

## Agent Roster

### Overview

```
                        ┌─────────────────────┐
                        │  Managing Director   │
                        │  (Final sign-off,    │
                        │   executive summary) │
                        └─────────┬───────────┘
                                  │
                        ┌─────────▼───────────┐
                        │   Senior Analyst     │
                        │   (Synthesis,        │
                        │    quality review)   │
                        └─────────┬───────────┘
                                  │
                    ┌─────────────┼─────────────┐
                    │                           │
          ┌─────────▼───────────┐   ┌───────────▼─────────┐
          │   Quant Analyst     │   │   News Analyst       │
          │   (Numbers, alpha/  │   │   (Search, themes,   │
          │    beta, technicals)│   │    sentiment)        │
          └─────────────────────┘   └──────────────────────┘
```

### Agent Definitions

#### 1. Quant Analyst
**Role:** The numbers person. Provides objective, data-driven technical assessment.

**Inputs:**
- Feature matrix for all candidates (from pipeline)
- Market-level data (SPY return, VIX, yield curve proxy)

**Tools:**
- Feature matrix reader (pandas)
- Alpha/beta decomposition calculator
- Technical indicator evaluator (price vs. MAs, RSI, Bollinger position, volume ratio)

**Outputs** (structured JSON per sector group + per symbol):
```json
{
  "market_context": {
    "spy_weekly_return": -3.2,
    "vix_level": 22.5,
    "regime": "bear",
    "regime_signal": "SPY below 50-DMA by 1.4%"
  },
  "sector_groups": [
    {
      "sector": "U.S. Financials",
      "symbols": ["VFH", "IYF", "IYG", "XLF", "XLFI"],
      "avg_return": -4.68,
      "avg_alpha_residual": -1.2,
      "interpretation": "Significant alpha — sector dropped more than beta explains"
    }
  ],
  "symbol_profiles": {
    "VFH": {
      "pct_return": -4.68,
      "beta": 0.97,
      "alpha_residual": -1.57,
      "price_vs_sma50": -3.2,
      "price_vs_sma200": +1.8,
      "rsi_14": 32.4,
      "bb_position": 0.08,
      "volume_ratio": 2.1,
      "atr_pct": 1.4,
      "quant_signal": "OVERSOLD",
      "quant_note": "Alpha residual of -1.57% suggests sector-specific selling beyond market. RSI near oversold. Volume 2.1x avg indicates institutional repositioning, not retail panic."
    }
  }
}
```

**Model:** None required (or optionally a small LLM for the `quant_note` narrative).
Most of this is pure computation. The `quant_note` could be template-based or LLM-generated.

**Key design principle:** The Quant Analyst deals in **facts**, not opinions. Every
number is verifiable. The narrative (if any) is tightly grounded in the numbers.

---

#### 2. News Analyst
**Role:** The qualitative researcher. Finds and synthesizes news to explain *why*
something moved.

**Inputs:**
- Candidate list with sector groupings (from Quant Analyst)
- Alpha residual per sector (from Quant Analyst) — knows where to focus effort

**Tools:**
- Web search (Tavily API)
- Sector-specific search query builder

**Search Strategy** (improved from v0.1):
1. **Market overview search** — 3 broad queries about this week's market drivers
2. **Per-sector search** (NOT per-symbol) — 2-3 queries per sector group
3. **Targeted deep-dive** — Only for sectors with high alpha residual (significant
   idiosyncratic movement), additional focused searches

**Outputs** (structured JSON):
```json
{
  "market_overview": {
    "summary": "...",
    "key_events": ["FOMC held rates steady", "DeepSeek AI announcement triggered tech sell-off"],
    "sources": [{"title": "...", "url": "..."}]
  },
  "sector_analyses": {
    "U.S. Financials": {
      "news_summary": "Major outflows from XLF ($1.16B) following Visa antitrust settlement. Yield curve flattening compressing NIM expectations.",
      "evidence_quality": "strong",
      "key_drivers": [
        {
          "driver": "Visa antitrust settlement ($1.2B)",
          "type": "transient",
          "evidence": "Reuters: Visa agreed to...",
          "affected_symbols": ["VFH", "IYF", "IYG", "XLF"]
        }
      ],
      "sources": [{"title": "...", "url": "..."}]
    }
  }
}
```

**Model:** GPT-4o or equivalent — needs strong synthesis ability.

**Key design principle:** Search per-SECTOR, not per-symbol. Eliminates the VFH/IYF
inconsistency problem. Focus search effort where alpha residual is high (something
specific happened) and reduce effort where alpha is low (just a market move).

---

#### 3. Senior Analyst (Synthesizer)
**Role:** Merges the Quant Analyst's numbers with the News Analyst's narratives.
Produces the per-symbol and per-sector assessments that appear in the dashboard.

**Inputs:**
- Quant Analyst output (full)
- News Analyst output (full)
- Sector groupings

**Outputs** (per sector + per symbol):
```json
{
  "sector_assessments": {
    "U.S. Financials": {
      "quant_view": "Oversold on RSI, significant alpha residual (-1.2%)",
      "news_view": "Visa settlement + yield curve concerns, evidence quality strong",
      "synthesis": "Sector dropped beyond what market beta explains. News identifies specific transient catalysts (Visa settlement). Technical indicators are oversold. Mean-reversion probability: elevated.",
      "drop_type": "transient",
      "confidence": "high"
    }
  },
  "symbol_assessments": {
    "VFH": {
      "flag": "GREEN",
      "flag_reason": "Alpha residual -1.57% with strong transient news driver (Visa settlement). RSI 32, BB position 0.08. High-probability mean-reversion candidate.",
      "evidence_quality": "strong",
      "news_summary": "...",
      "quant_summary": "...",
      "bullish_signals": ["RSI oversold", "Transient catalyst", "Volume spike suggests capitulation"],
      "bearish_signals": ["Yield curve concern is more persistent"],
      "key_concern": "If yield curve continues to flatten, NIM compression becomes structural"
    }
  }
}
```

**Model:** GPT-4o — this is the most demanding synthesis task.

**Key design principle:** The Senior Analyst NEVER searches for news or computes
numbers. It only synthesizes what the specialists provide. This prevents it from
going off-script or hallucinating data it doesn't have.

---

#### 4. Managing Director (Final Review)
**Role:** Executive-level sign-off. Reviews the Senior Analyst's work for:
- Internal consistency (do the flags match the evidence?)
- Missing perspectives (did we overlook a macro risk?)
- Portfolio-level view (are we overweight in one sector?)
- Executive summary for the dashboard

**Inputs:**
- Senior Analyst output (full)
- Quant Analyst market context
- Portfolio-level statistics (how many candidates per sector, total capital allocation)

**Outputs:**
```json
{
  "quality_score": 8,
  "quality_rationale": "Analysis is well-grounded in quant data and news evidence. Two concerns: (1) European financials analysis relies on thin evidence — flag appropriately as YELLOW. (2) Portfolio is 60% financial sector — concentration risk noted.",
  "flag_adjustments": [
    {"symbol": "EUFN", "from": "GREEN", "to": "YELLOW", "reason": "Evidence quality weak for European-specific drivers"}
  ],
  "strongest_candidates": ["VFH", "XLF"],
  "weakest_candidates": ["KRE", "XSW"],
  "blind_spots": ["No analysis of options-implied volatility", "Chile (ECH) may have commodity-specific drivers not captured"],
  "executive_summary": "32 candidates identified, heavily concentrated in U.S. financials (8 ETFs). Sector decline driven by Visa settlement and yield curve fears — both largely transient. Recommend prioritizing VFH and XLF (strong quant + news alignment). Avoid KRE (structural CRE concerns). Overall: favorable for mean-reversion trades this week.",
  "portfolio_note": "60% financial sector concentration. Consider position limits."
}
```

**Model:** GPT-4o or Claude — needs strong critical reasoning and the ability to
spot what's missing, not just evaluate what's present.

**Key design principle:** The MD operates on the *full picture* — all sector
assessments, all symbol assessments, and the portfolio composition. This is the only
agent that sees everything at once. It's the "fresh eyes" that catches cross-cutting
issues.

---

## Workflow Architecture

### Execution Flow

```
Phase 1: PREPARATION (no LLM needed)
  ┌─────────────────────────────┐
  │  Pipeline Runner             │
  │  - Load feature matrix       │
  │  - Compute alpha residuals   │
  │  - Assign sector groups      │
  │  - Generate candidate list   │
  └──────────────┬──────────────┘
                 │
Phase 2: SPECIALIST ANALYSIS (parallel)
                 │
       ┌─────────┴─────────┐
       │                   │
  ┌────▼────┐        ┌────▼────┐
  │  Quant  │        │  News   │
  │ Analyst │        │ Analyst │
  └────┬────┘        └────┬────┘
       │                   │
       └─────────┬─────────┘
                 │
Phase 3: SYNTHESIS (sequential)
                 │
       ┌─────────▼─────────┐
       │  Senior Analyst    │
       │  (merge quant +    │
       │   news per sector  │
       │   and per symbol)  │
       └─────────┬─────────┘
                 │
Phase 4: REVIEW (sequential)
                 │
       ┌─────────▼─────────┐
       │  Managing Director │
       │  (final review,    │
       │   executive brief) │
       └─────────┬─────────┘
                 │
Phase 5: RENDER
                 │
       ┌─────────▼─────────┐
       │  Dashboard Builder  │
       │  (HTML inspector    │
       │   + standalone      │
       │   report)           │
       └─────────────────────┘
```

### Key Architectural Decisions

#### Parallel Execution (Phase 2)
The Quant Analyst and News Analyst can run in parallel with one important nuance:
the News Analyst benefits from knowing the sector groupings and alpha residuals
(to focus search effort). Two options:

- **Option A:** Quant runs first (fast — pure computation, <1 second), then News
  runs with quant context. Simple, minimal latency cost.
- **Option B:** Both run truly in parallel. News uses a simpler heuristic for sector
  grouping (ETF name keyword matching, which we already have) and doesn't get alpha
  residuals. Slightly faster but News doesn't know where to focus.

**Recommendation:** Option A. The Quant Analyst is so fast (no LLM calls) that the
"sequential" cost is negligible, and the benefit (alpha-guided search focus) is real.

#### Sector Grouping
ETFs are grouped by sector before any analysis. This is the single most impactful
architectural change from v0.1. Options:

- **Lookup table:** Maintain a curated mapping of ETF symbols to sectors. Simple,
  deterministic, but requires maintenance.
- **ETF name parsing:** Extract sector from ETF name (already prototyped in
  `_extract_sector_terms`). Covers most cases but noisy.
- **External data:** Use ETF.com or Morningstar category data. Most accurate but adds
  an external dependency.
- **LLM classification:** Ask an LLM to classify ETFs into sectors. Flexible but slow
  and potentially inconsistent.

**Recommendation:** Start with ETF name parsing + a small override table for known
problem cases. Graduate to external data source if accuracy matters.

#### State Management
v0.1 used a single `TypedDict` (`AnalystState`) that grew with every feature.
v0.2 should use **typed message passing** between agents:

```python
@dataclass
class QuantOutput:
    market_context: MarketContext
    sector_groups: List[SectorGroup]
    symbol_profiles: Dict[str, SymbolProfile]

@dataclass
class NewsOutput:
    market_overview: MarketOverview
    sector_analyses: Dict[str, SectorNewsAnalysis]

@dataclass
class SeniorOutput:
    sector_assessments: Dict[str, SectorAssessment]
    symbol_assessments: Dict[str, SymbolAssessment]

@dataclass
class MDOutput:
    quality_score: int
    executive_summary: str
    flag_adjustments: List[FlagAdjustment]
    portfolio_note: str
```

Each agent receives typed inputs and produces typed outputs. No shared mutable state.

#### LangGraph Implementation
LangGraph supports subgraphs and parallel node execution. The architecture maps cleanly:

```python
# Top-level graph
workflow = StateGraph(OverallState)

# Phase 1: Preparation (regular function, no LLM)
workflow.add_node("prepare", prepare_candidates)

# Phase 2: Specialist analysis
# Option A: sequential (quant first, then news with quant context)
workflow.add_node("quant_analyst", quant_analyst_node)
workflow.add_node("news_analyst", news_analyst_node)

# Phase 3-4: Synthesis and review
workflow.add_node("senior_analyst", senior_analyst_node)
workflow.add_node("managing_director", md_node)

# Phase 5: Render
workflow.add_node("render", render_dashboard)

# Edges
workflow.add_edge("prepare", "quant_analyst")
workflow.add_edge("quant_analyst", "news_analyst")
workflow.add_edge("news_analyst", "senior_analyst")
workflow.add_edge("senior_analyst", "managing_director")
workflow.add_edge("managing_director", "render")
```

If we want true parallel Phase 2 (Option B), LangGraph supports it via
`add_conditional_edges` or parallel node execution.

---

## Quant Feature Injection — The Alpha/Beta Core

### What We Compute

The Quant Analyst computes these features for every candidate. Most already exist
in the feature matrix; a few are new:

| Feature | Source | Status | Purpose |
|---------|--------|--------|---------|
| `pct_return` | Feature matrix | Exists | Raw weekly return |
| `beta` | Feature matrix | Exists | Market sensitivity |
| `spy_return` | Feature matrix | **New** | Market return this week |
| `alpha_residual` | Computed | **New** | `return - (beta * spy_return)` |
| `price_vs_sma50` | Feature matrix | Check | Trend (% above/below 50-DMA) |
| `price_vs_sma200` | Feature matrix | Check | Secular trend |
| `rsi_14` | Feature matrix | Check | Momentum oscillator |
| `bb_position` | Feature matrix | Check | 0=lower band, 1=upper band |
| `volume_ratio` | Feature matrix | Check/New | This week vs 20-day avg |
| `atr_pct` | Feature matrix | Exists | Volatility |
| `sigma` | Feature matrix | Exists | Return volatility |

### How It Changes the Analysis

**Before (v0.1):**
> "VFH declined 4.68% this week amid concerns about AI disruption in financial
> services and significant outflows."

**After (v0.2):**
> "VFH declined 4.68% (alpha residual: -1.57%, meaning 3.11% is market-wide and
> 1.57% is sector-specific). RSI at 32 (near oversold). Volume 2.1x average suggests
> institutional repositioning. The sector-specific component appears driven by the
> Visa antitrust settlement ($1.2B). This is a transient catalyst with high
> mean-reversion probability."

The difference: every claim is grounded in a number, and the reader knows exactly
how much of the drop is "the market" vs. "something specific."

---

## Epistemic Honesty Protocol

A formal protocol for when evidence is weak:

### For the News Analyst
```
IF evidence_quality == "none":
    output: "No sector-specific news found. Unable to identify idiosyncratic catalyst."
    DO NOT generate narrative.

IF evidence_quality == "weak":
    output: "Limited evidence found: [cite what exists]. Insufficient to determine
    specific catalyst with confidence."
    DO NOT extrapolate beyond what the evidence shows.
```

### For the Senior Analyst
```
IF news evidence is none AND alpha_residual is small (< 0.5%):
    synthesis: "Decline is primarily explained by market-wide movement (beta).
    No idiosyncratic catalyst identified. This is a pure beta mean-reversion trade."
    flag: YELLOW (insufficient evidence for GREEN)

IF news evidence is none AND alpha_residual is large (> 1.5%):
    synthesis: "Significant idiosyncratic decline (-X% beyond market) but no news
    explanation found. CAUTION: unexplained alpha — may indicate information we
    haven't captured (insider activity, block trade, index rebalance)."
    flag: RED (unexplained large alpha is a warning, not an opportunity)
```

### For the Managing Director
```
IF many symbols have evidence_quality "none" or "weak":
    quality_note: "Analysis is data-constrained this week. X of Y sectors lack
    strong news evidence. Quant signals are the primary basis for recommendations."
```

---

## Open Design Questions

### 1. How much should agents "see" of each other's work?
- Should the News Analyst see the Quant output? (Recommended: yes — focus search effort)
- Should the Senior Analyst see raw news articles or just the News Analyst's summary?
- Should the MD see everything or just the Senior Analyst's output?

**Current lean:** Each agent sees its predecessor's output. The MD sees Senior Analyst
output + Quant market context (for portfolio-level statistics). No agent goes back
to raw data except through its own tools.

### 2. Should there be feedback loops?
v0.1 had a single review step. v0.2 could have:
- MD sends Senior Analyst back for revision on specific sectors
- Senior Analyst asks News Analyst for additional searches on high-alpha sectors

This is architecturally interesting (conditional edges in LangGraph) but adds complexity
and latency. **Recommendation:** Implement as a stretch goal. Start with single-pass
through the hierarchy.

### 3. Model assignment per agent
| Agent | Recommended Model | Rationale |
|-------|------------------|-----------|
| Quant Analyst | None (computation) | No LLM needed |
| News Analyst | GPT-4o | Needs strong synthesis of search results |
| Senior Analyst | GPT-4o | Most demanding synthesis task |
| Managing Director | GPT-4o or Claude | Needs critical reasoning, spotting gaps |

Cost projection (32 candidates, ~5 sector groups):
- News Analyst: ~1 call per sector × 5 sectors + 1 overview = ~6 LLM calls
- Senior Analyst: 1 call per sector + 1 overall = ~6 LLM calls
- Managing Director: 1 call = 1 LLM call
- Total: ~13 LLM calls (vs 34 in v0.1)
- Estimated cost: ~$0.05–0.10 per run (higher per-call cost but fewer calls)

### 4. Unified script design
Eliminate the 19.3 vs 21b split. Single script:
```
weekly_analyst.py --config config/strategy.yaml
```
- Strategy parameters in YAML (not hardcoded)
- Single output directory per run
- Dashboard includes quant profile + AI analysis
- Backward-compatible with existing pipeline steps

### 5. What framework for multi-agent?
Options considered:
- **LangGraph (current):** Supports subgraphs, parallel execution, typed state.
  We already know it. Natural evolution from v0.1.
- **AutoGen:** Microsoft's multi-agent framework. Good for conversational agent
  patterns. More overhead than we need.
- **CrewAI:** Role-based multi-agent with built-in delegation. Higher-level API
  but less control over execution flow.

**Recommendation:** Stay with LangGraph. We know it, it's flexible, and the
multi-agent pattern we want (specialist → synthesizer → reviewer) maps cleanly
to its graph model. Moving to AutoGen or CrewAI would be a learning exercise in
its own right — save that for v0.3 if we want to compare approaches.

---

## Implementation Phases

### Phase 2a: Foundation (prerequisite)
- [ ] Unify pipeline into single script with YAML config
- [ ] Add sector grouping (ETF name parsing + override table)
- [ ] Compute alpha residual and verify quant features exist in feature matrix
- [ ] Define typed dataclasses for inter-agent messages
- [ ] Restructure `src/analyst/` for multi-agent

### Phase 2b: Quant Analyst
- [ ] Implement Quant Analyst node (pure Python, no LLM)
- [ ] Generate quant profiles per symbol and per sector
- [ ] Compute alpha/beta decomposition
- [ ] Template-based quant narrative (or small LLM call)

### Phase 2c: News Analyst
- [ ] Refactor search to operate per-sector (not per-symbol)
- [ ] Market overview search (already implemented in v0.1)
- [ ] Alpha-guided search intensity (more effort on high-alpha sectors)
- [ ] Structured news output with evidence quality ratings

### Phase 2d: Senior Analyst + Managing Director
- [ ] Implement Senior Analyst synthesis node
- [ ] Implement Managing Director review node
- [ ] Epistemic honesty protocol enforcement
- [ ] Portfolio-level analysis (sector concentration, total capital)

### Phase 2e: Dashboard + Integration
- [ ] Unified dashboard rendering from multi-agent output
- [ ] Quant profile panel in inspector (alpha residual, RSI, volume)
- [ ] Updated analyst report with agent attribution
- [ ] MLflow tracking updated for multi-agent metrics

---

## Success Criteria

How we'll know v0.2 is better than v0.1:

1. **No more hallucinated narratives** — every claim traces to either a number or a
   news source. Spot-check 10 random symbols for grounding.
2. **Sector consistency** — neighboring ETFs in the same sector get the same sector-level
   narrative with per-symbol nuances, not contradictory stories.
3. **Alpha/beta clarity** — every assessment explicitly separates market-wide movement
   from sector-specific movement. Reader can tell at a glance.
4. **Honest "I don't know"** — at least 20% of low-evidence symbols should have analysis
   that explicitly says "no specific catalyst identified" rather than fabricating one.
5. **Reduced LLM calls** — fewer total calls (sector-level, not symbol-level) with
   higher quality per call.
6. **Demo quality** — the dashboard tells a coherent story that a non-technical
   viewer can follow from executive summary → sector themes → individual trade.
